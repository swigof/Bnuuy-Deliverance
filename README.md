# Bnuuy Deliverance

A package delivery needle platformer for the Game Boy.

This repo used to be my testbed for GBDK development until March 2025 when I decided to commit 
to building a Game Boy game.

This project is messier than I would like.
Early on, I was very concerned with having robust implementations and project structure, only to 
encounter hardware limitations that challenged that later on. Combined with time constraints, 
some parts of this are now over-engineered while other bits are assembled ad-hoc.

## Assets

The project needs certain assets placed in a top level `res` folder

* `res/sprites/{x}_sheet.png` spritesheets of various entities
* `res/tiles/tileset_primary.png` tilesheet for background tiles
* `res/levels/level_{x}.png` level images built respecting tileset_primary
* `res/music/{x}_track.c` hUGETracker exported songs
* `res/sfx/SFX_{x}.[c/h]` CBT-FX exported sound effects

The image files are processed with GBDK's `png2asset` as defined in the Makefile

Care should be taken to avoid having source files in the project which match the names of those 
generated by the build from the assets.

## Builds

The project can be built with Make using the top level Makefile.

[GBDK](https://github.com/gbdk-2020/gbdk-2020/releases) and 
[hUGEDriver](https://github.com/SuperDisk/hUGEDriver/releases) are needed.
By default, they are expected to be in the directory above the project.
Alternatively, you can set `GBDK_HOME` and/or `HUGE_HOME`  in your environment to paths 
elsewhere.

The project was originally built with GBDK 4.3.0 and hUGEDriver 6.1.3.

In addition to these, [CBT-FX](https://github.com/coffeevalenbat/CBT-FX) is included directly in 
the project files.

## Environment

Your IDE of choice should be configured to include the `GBDK/include` and `hUGEDriver/include`
directories, wherever they are placed.
The `__PORT_sm83` and `__TARGET_gb` defines should be set.

## Engine Notes

### Entities
* Each entity should have a source definition (`entity_t`) and spritesheet
  * The source definition details its various states and the metasprites to use in each state
  * Sprite data for all of an entity's metasprites should be fully set before being made active
* Spritesheets should have their animations placed in sequence in left to right, top to bottom 
  order
* Sprites in spritesheets should be centered horizontally and vertically on their hitboxes
  * `-pw` and `-ph` in the `png2asset` calls of the Makefile should be set to the distance from
    the center to the hitbox edge
* Entities update mostly through their own pre-defined functions
  * There are generic functions that can be used for velocity movement and collision
    * However, velocity changes need to be handled by the entity's update function
* New entities are added via the `add_entity` function
  * This adds an entity to a fixed-sized RAM array if there is space
  * Entities which have the active flag unset may be removed when adding a new entity

### Levels/Maps

* Similarly to entities, levels should have a map image respecting the primary tileset and 
  a `level_t`
* Levels have an init function which should initialize all entities and the camera as needed
* Levels have an update function pointer which, if set, allows them to override normal main loop
  update behavior
* Maps can only scroll vertically
* Maps must have a width of 20 and a height between 19 and 255 inclusive
  * `camera_y` will always start with a value of 8 or more to buffer one line lower
* 4 types of collision are defined for maps from the tileset
  * `TT_SOLID` tile index 112+, fully collideable tiles
  * `TT_PLATFORM` tile index 108-111, top only collideable tiles
  * `TT_HAZARD` tile index 104-107, unused but would be for tiles which cause damage
  * `TT_NONE` tile index 0-106, tiles with no collision
* Each tile needs to be unique in the tileset to ensure consistent map builds
  * No collision variants of the exact same tiles should exist

### Banking

Banks 0 and 1 are used largely by default, with bank 1 being briefly switched from to access 
data in other banks as needed.
Bank 1 is leveraged as much as possible for principle code and data to avoid filling the 
valuable bank 0 space.

Layout:
* ROM 0: Specifically NONBANKED code which needs to switch banks, music, and sfx
* ROM 1: All other code/data, and spritesheets
* ROM 2: Levels, and map tilesets
* ROM 3: Levels

### Known Issues

* The box can clip through ceilings when thrown by the player
* The collision and camera only work as long as everything moves less than 9 pixels per cycle
* The entity collision detection is quite expensive
* Collision detection reads from illegal addresses when any hitbox edge is off the map
* The top line of tiles doesn't render correctly when initializing the camera at the top of a 
  map
* Entities stop rendering when at the top of a map since their y=0, which prevents sprite 
  display

## Resources

https://gbdev.io/

https://gbdk-2020.github.io/gbdk-2020/docs/api/index.html

https://sdcc.sourceforge.net/doc/sdccman.pdf

https://laroldsretrogameyard.com/
